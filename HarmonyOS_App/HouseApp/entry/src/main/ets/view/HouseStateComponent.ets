import { IAMTokenPreferencesDataUtil } from '../utils/IAMTokenPreferencesDataUtil';
import axios, { AxiosError, AxiosResponse } from '@ohos/axios';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { SensorInfo } from '../model/SensorInfo';

// å®šä¹‰ç¯å…‰æ§åˆ¶è¯·æ±‚å‚æ•°æ¥å£
interface LightControlParams {
  onoff: string;
}

// å®šä¹‰ç¯å…‰æ§åˆ¶è¯·æ±‚æ¥å£
interface LightControlRequest {
  service_id: string;
  command_name: string;
  paras: LightControlParams;
}

// å®šä¹‰éœ‡åŠ¨æ§åˆ¶è¯·æ±‚å‚æ•°æ¥å£
interface MotorControlParams {
  onoff: string;
}

// å®šä¹‰éœ‡åŠ¨æ§åˆ¶è¯·æ±‚æ¥å£
interface MotorControlRequest {
  service_id: string;
  command_name: string;
  paras: MotorControlParams;
}

// å®šä¹‰å¯»æ‰¾è¯ç®±è¯·æ±‚å‚æ•°æ¥å£
interface FindBoxParams {
  onoff: string;
}

// å®šä¹‰å¯»æ‰¾è¯ç®±è¯·æ±‚æ¥å£
interface FindBoxRequest {
  service_id: string;
  command_name: string;
  paras: FindBoxParams;
}

// åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ è¯å“æ¥å£å®šä¹‰
interface Medicine {
  id: number;
  name: string;
  times: string[];
  frequency: string;
  location: string;
}

interface MqttControlParams {
  value: string;
}

// å®šä¹‰MQTTæ§åˆ¶è¯·æ±‚æ¥å£
interface MqttControlRequest {
  service_id: string;
  command_name: string;
  paras: MqttControlParams;
}

interface MissedMedicineItem {
  medicine: Medicine;
  missedTime: string;
}


// æ·»åŠ èœ‚é¸£å™¨æ§åˆ¶å‚æ•°æ¥å£
interface BeepControlParams {
  onoff: string;
}

// æ·»åŠ èœ‚é¸£å™¨æ§åˆ¶è¯·æ±‚æ¥å£
interface BeepControlRequest {
  service_id: string;
  command_name: string;
  paras: BeepControlParams;
}

interface UserInfo {
  id: number;
  name: string;
  avatar: Resource;
  signature: string;
}

@Component
export default struct HouseStateComponent {
  @State sensorInfo: SensorInfo = new SensorInfo();
  @State lightStatus: boolean = false; // ç¯å…‰å¼€å…³çŠ¶æ€
  @State vibrationStatus: boolean = false; // éœ‡åŠ¨å¼€å…³çŠ¶æ€
  @State findBoxStatus: boolean = false; // å¯»æ‰¾è¯ç®±çŠ¶æ€
  @State currentUserName: string = 'Dove'; // å½“å‰ç”¨æˆ·å
  @State userList: Array<UserInfo> = [
    {
      id: 1,
      name: 'Dove',
      avatar: $r('app.media.user_avtar'),
      signature: 'ç®¡ç†è´¦å·'
    },
    {
      id: 2,
      name: 'Young',
      avatar: $r('app.media.young_avtar'),
      signature: 'å¹´è½»ç”¨æˆ·ï¼Œæ´»åŠ›æ»¡æ»¡'
    },
    {
      id: 3,
      name: 'Elder',
      avatar: $r('app.media.old_avtar'),
      signature: 'é•¿è€…ç”¨æˆ·ï¼Œç»éªŒä¸°å¯Œ'
    }
  ];
  // æ·»åŠ è¯å“åˆ—è¡¨çŠ¶æ€å˜é‡
  @State medicineList: Array<Medicine> = [];
  // æ·»åŠ å·²æ£€æŸ¥è¯å“è®°å½•
  private checkedMedicines: Set<string> = new Set();

  // æ·»åŠ å¯»æ‰¾è¯ç®±å®šæ—¶å™¨å˜é‡
  private findBoxTimerId: number = 0; // å¯»æ‰¾è¯ç®±å®šæ—¶å™¨ID
  // æ·»åŠ ç¬¬ä¸€æ¬¡è¿æ¥æ ‡å¿—
  private isFirstConnection: boolean = true; // æ˜¯å¦ç¬¬ä¸€æ¬¡è¿æ¥è®¾å¤‡

  private timerId: number = 0;//è®¡æ—¶å™¨idï¼Œæ¯3ç§’è¯»å–ä¸€æ¬¡æ•°æ®

  @Builder
  IconOverlay(icon: string) {
    Text(icon)
      .fontSize(24)
  }

  @Builder
  SwitchOverlay() {
    Text('â—‹')
      .fontSize(12)
      .fontColor('#ffffff')
  }

  @Builder
  NotificationDot() {
    Circle({width: 6, height: 6})
      .fill('#ff4444')
      .position({x: 8, y: -2})
  }

  @Builder
  ActiveIndicator() {
    Rect({width: 20, height: 2})
      .fill('#0066cc')
  }

  // æ§åˆ¶ç¯å…‰å¼€å…³çš„æ–¹æ³•
  controlLight = (onoff: string): void => {
    const token = IAMTokenPreferencesDataUtil.init().getPreferencesData('token');
    // ä¿®æ­£ï¼šä½¿ç”¨commandsè·¯å¾„è€Œä¸æ˜¯propertiesè·¯å¾„
    const url = 'https://61357a1900.st1.iotda-app.cn-north-4.myhuaweicloud.com:443/v5/iot/5390eb2140d2435c91cadccf942fb3eb/devices/685f8b5ed582f2001835e760_Smart_Medicien_Box/commands';
    
    const requestData: LightControlRequest = {
      service_id: "IntelligentCookpit",
      command_name: "light_control",
      paras: {
        onoff: onoff
      }
    };
  
    const axiosInstance = axios.create({
      headers: {
        "Content-Type": "application/json",
        "X-Auth-Token": token
      }
    });
  
    // ä¿®æ­£ï¼šä½¿ç”¨POSTæ–¹æ³•è€Œä¸æ˜¯PUTæ–¹æ³•
    axiosInstance.post(url, requestData).then((response: AxiosResponse) => {
      console.log('ç¯å…‰æ§åˆ¶æˆåŠŸ:', JSON.stringify(response.data));
      hilog.info(2311, 'testTag', 'ç¯å…‰æ§åˆ¶æˆåŠŸ:', JSON.stringify(response.data));
    }).catch((error: AxiosError) => {
      console.log('ç¯å…‰æ§åˆ¶å¤±è´¥:', JSON.stringify(error));
      hilog.error(2311, 'testTag', 'ç¯å…‰æ§åˆ¶å¤±è´¥:', JSON.stringify(error));
    });
  }

  // æ§åˆ¶éœ‡åŠ¨ç”µæœºçš„æ–¹æ³•
  controlMotor = (onoff: string): void => {
    const token = IAMTokenPreferencesDataUtil.init().getPreferencesData('token');
    const url = 'https://61357a1900.st1.iotda-app.cn-north-4.myhuaweicloud.com:443/v5/iot/5390eb2140d2435c91cadccf942fb3eb/devices/685f8b5ed582f2001835e760_Smart_Medicien_Box/commands';
    
    const requestData: MotorControlRequest = {
      service_id: "IntelligentCookpit",
      command_name: "motor_control",
      paras: {
        onoff: onoff
      }
    };

    const axiosInstance = axios.create({
      headers: {
        "Content-Type": "application/json",
        "X-Auth-Token": token
      }
    });

    axiosInstance.post(url, requestData).then((response: AxiosResponse) => {
      console.log('éœ‡åŠ¨æ§åˆ¶æˆåŠŸ:', JSON.stringify(response.data));
      hilog.info(2311, 'testTag', 'éœ‡åŠ¨æ§åˆ¶æˆåŠŸ:', JSON.stringify(response.data));
    }).catch((error: AxiosError) => {
      console.log('éœ‡åŠ¨æ§åˆ¶å¤±è´¥:', JSON.stringify(error));
      hilog.error(2311, 'testTag', 'éœ‡åŠ¨æ§åˆ¶å¤±è´¥:', JSON.stringify(error));
    });
  }

  // è·å–å½±å­æ•°æ®çš„æ–¹æ³•
  getSensorAll = (): void => {
    const token = IAMTokenPreferencesDataUtil.init().getPreferencesData('token');
    // æ™ºèƒ½è¯ç›’è®¾å¤‡çš„å½±å­æ•°æ®URL
    const url = 'https://61357a1900.st1.iotda-app.cn-north-4.myhuaweicloud.com:443/v5/iot/5390eb2140d2435c91cadccf942fb3eb/devices/685f8b5ed582f2001835e760_Smart_Medicien_Box/shadow';
    const axiosInstance = axios.create({
      headers:{
        "Content-Type": "application/json",
        "X-Auth-Token": token
      }
    });

    axiosInstance.get(url).then((response: AxiosResponse) => {
      const shadow: string = JSON.stringify(response.data['shadow']);
      const shadowObject = JSON.parse(shadow)[0].reported.properties as SensorInfo;
      // é€ä¸ªå±æ€§è¿›è¡Œèµ‹å€¼ - æ™ºèƒ½è¯ç›’ç›¸å…³å±æ€§
      this.sensorInfo.temperature = shadowObject.temperature;
      this.sensorInfo.illumination = shadowObject.illumination;
      this.sensorInfo.humidity = shadowObject.humidity;
      this.sensorInfo.motorStatus = shadowObject.motorStatus;
      this.sensorInfo.lightStatus = shadowObject.lightStatus;
      this.sensorInfo.autoStatus = shadowObject.autoStatus;
      this.sensorInfo.gas = shadowObject.gas;
      
      // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿æ¥æˆåŠŸï¼Œæ˜¾ç¤ºæç¤ºæ¡†
      if (this.isFirstConnection) {
        this.isFirstConnection = false;
        // æ˜¾ç¤ºè®¾å¤‡è¿æ¥æˆåŠŸæç¤ºæ¡†
        AlertDialog.show({
          title: 'æç¤º',
          message: 'è®¾å¤‡è¿æ¥æˆåŠŸ!',
          autoCancel: true,
          alignment: DialogAlignment.Center,
          confirm: {
            value: 'ç¡®å®š',
            action: () => {
              console.log('è®¾å¤‡è¿æ¥æˆåŠŸæç¤ºæ¡†å·²ç¡®è®¤');
            }
          }
        });
      }
      
      console.log('è·å–çš„å½±å­æ•°æ®æ˜¯: : ', JSON.stringify(shadow))
      hilog.info(2311, 'testTag', 'è·å–çš„å½±å­æ•°æ®æ˜¯: ', JSON.stringify(this.sensorInfo))
    }).catch((error: AxiosError) => {
      console.log('testTag', JSON.stringify(error));
    })
  }

  // æ§åˆ¶å¯»æ‰¾è¯ç®±çš„æ–¹æ³•
  findBox = (): void => {
    const token = IAMTokenPreferencesDataUtil.init().getPreferencesData('token');
    const url = 'https://61357a1900.st1.iotda-app.cn-north-4.myhuaweicloud.com:443/v5/iot/5390eb2140d2435c91cadccf942fb3eb/devices/685f8b5ed582f2001835e760_Smart_Medicien_Box/commands';
    
    if (this.findBoxStatus) {
      // å¼€å¯çŠ¶æ€ï¼šåŒæ—¶å‘é€find_boxã€beep_controlå’Œmotor_controlå‘½ä»¤
      const findBoxRequest: FindBoxRequest = {
        service_id: "IntelligentCookpit",
        command_name: "find_box",
        paras: {
          onoff: "ON"
        }
      };

      const beepRequest: BeepControlRequest = {
        service_id: "IntelligentCookpit",
        command_name: "beep_control",
        paras: {
          onoff: "ON"
        }
      };

      const motorRequest: MotorControlRequest = {
        service_id: "IntelligentCookpit",
        command_name: "motor_control",
        paras: {
          onoff: "ON"
        }
      };

      const axiosInstance = axios.create({
        headers: {
          "Content-Type": "application/json",
          "X-Auth-Token": token
        }
      });

      // å‘é€find_boxå‘½ä»¤
      axiosInstance.post(url, findBoxRequest).then((response: AxiosResponse) => {
        console.log('å¯»æ‰¾è¯ç®±å¼€å¯æˆåŠŸ:', JSON.stringify(response.data));
        hilog.info(2311, 'testTag', 'å¯»æ‰¾è¯ç®±å¼€å¯æˆåŠŸ:', JSON.stringify(response.data));
      }).catch((error: AxiosError) => {
        console.log('å¯»æ‰¾è¯ç®±å¼€å¯å¤±è´¥:', JSON.stringify(error));
        hilog.error(2311, 'testTag', 'å¯»æ‰¾è¯ç®±å¼€å¯å¤±è´¥:', JSON.stringify(error));
      });

      // å‘é€beep_controlå‘½ä»¤
      axiosInstance.post(url, beepRequest).then((response: AxiosResponse) => {
        console.log('èœ‚é¸£å™¨å¼€å¯æˆåŠŸ:', JSON.stringify(response.data));
        hilog.info(2311, 'testTag', 'èœ‚é¸£å™¨å¼€å¯æˆåŠŸ:', JSON.stringify(response.data));
      }).catch((error: AxiosError) => {
        console.log('èœ‚é¸£å™¨å¼€å¯å¤±è´¥:', JSON.stringify(error));
        hilog.error(2311, 'testTag', 'èœ‚é¸£å™¨å¼€å¯å¤±è´¥:', JSON.stringify(error));
      });

      // å‘é€motor_controlå‘½ä»¤
      axiosInstance.post(url, motorRequest).then((response: AxiosResponse) => {
        console.log('éœ‡åŠ¨å¼€å¯æˆåŠŸ:', JSON.stringify(response.data));
        hilog.info(2311, 'testTag', 'éœ‡åŠ¨å¼€å¯æˆåŠŸ:', JSON.stringify(response.data));
      }).catch((error: AxiosError) => {
        console.log('éœ‡åŠ¨å¼€å¯å¤±è´¥:', JSON.stringify(error));
        hilog.error(2311, 'testTag', 'éœ‡åŠ¨å¼€å¯å¤±è´¥:', JSON.stringify(error));
      });

      // è®¾ç½®20ç§’åè‡ªåŠ¨å…³é—­
      this.findBoxTimerId = setTimeout(() => {
        this.findBoxStatus = false;
        this.vibrationStatus = false;
        this.autoCloseFindBox();
      }, 20000);

    } else {
      // å…³é—­çŠ¶æ€ï¼šæ¸…é™¤å®šæ—¶å™¨å¹¶å‘é€å…³é—­å‘½ä»¤
      if (this.findBoxTimerId) {
        clearTimeout(this.findBoxTimerId);
        this.findBoxTimerId = 0;
      }
      this.autoCloseFindBox();
    }
  }

  // è‡ªåŠ¨å…³é—­å¯»æ‰¾è¯ç®±åŠŸèƒ½çš„æ–¹æ³•
  private autoCloseFindBox = (): void => {
    const token = IAMTokenPreferencesDataUtil.init().getPreferencesData('token');
    const url = 'https://61357a1900.st1.iotda-app.cn-north-4.myhuaweicloud.com:443/v5/iot/5390eb2140d2435c91cadccf942fb3eb/devices/685f8b5ed582f2001835e760_Smart_Medicien_Box/commands';
    
    const findBoxRequest: FindBoxRequest = {
      service_id: "IntelligentCookpit",
      command_name: "find_box",
      paras: {
        onoff: "OFF"
      }
    };

    const beepRequest: BeepControlRequest = {
      service_id: "IntelligentCookpit",
      command_name: "beep_control",
      paras: {
        onoff: "OFF"
      }
    };

    const motorRequest: MotorControlRequest = {
      service_id: "IntelligentCookpit",
      command_name: "motor_control",
      paras: {
        onoff: "OFF"
      }
    };

    const axiosInstance = axios.create({
      headers: {
        "Content-Type": "application/json",
        "X-Auth-Token": token
      }
    });

    // å‘é€å…³é—­å‘½ä»¤
    axiosInstance.post(url, findBoxRequest).catch((error: AxiosError) => {
      console.log('å¯»æ‰¾è¯ç®±å…³é—­å¤±è´¥:', JSON.stringify(error));
    });

    axiosInstance.post(url, beepRequest).catch((error: AxiosError) => {
      console.log('èœ‚é¸£å™¨å…³é—­å¤±è´¥:', JSON.stringify(error));
    });

    axiosInstance.post(url, motorRequest).catch((error: AxiosError) => {
      console.log('éœ‡åŠ¨å…³é—­å¤±è´¥:', JSON.stringify(error));
    });

    console.log('å¯»æ‰¾è¯ç®±åŠŸèƒ½å·²è‡ªåŠ¨å…³é—­');
    hilog.info(2311, 'testTag', 'å¯»æ‰¾è¯ç®±åŠŸèƒ½å·²è‡ªåŠ¨å…³é—­');
  }

  // æ·»åŠ ç”¨æˆ·ç®¡ç†æ–¹æ³•
private getUserNameFromStorage(): string {
  // ä»æœ¬åœ°å­˜å‚¨è·å–å½“å‰ç”¨æˆ·åï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›é»˜è®¤å€¼
  const token = IAMTokenPreferencesDataUtil.init().getPreferencesData('currentUser');
  return token || 'Dove';
}

private saveCurrentUser(userName: string): void {
  // ä¿å­˜å½“å‰ç”¨æˆ·ååˆ°æœ¬åœ°å­˜å‚¨
  IAMTokenPreferencesDataUtil.init().setPreferencesData('currentUser', userName);
}

// ç›‘å¬ç”¨æˆ·åˆ‡æ¢äº‹ä»¶çš„æ–¹æ³•
private checkUserChange(): void {
  const storedUser = this.getUserNameFromStorage();
  if (storedUser !== this.currentUserName) {
    this.currentUserName = storedUser;
  }
}

  build(){
    Scroll() {
      Column({space: 16}){
        // é¡¶éƒ¨çŠ¶æ€æ 
        Row(){
          Text('æ™ºèƒ½è¯ç›’')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          
          Blank()

        }
        .width('100%')
        .padding({left: 16, right: 16, top: 16})
        
        // ä¸»è¦ä¿¡æ¯å¡ç‰‡
      Column({space: 12}){
          
        Image($r('app.media.HAVVK'))
            .width(280)
            .height(160)
            .objectFit(ImageFit.Contain)
            .margin({top: 20, bottom: 20})

        Text(`å½“å‰ç”¨æˆ·: ${this.currentUserName}`)
          .fontSize(12)
          .fontColor('#999999')
          .margin({bottom: 20})
        }
        .width('100%')
        .backgroundColor('#ffffff')
        .borderRadius(12)
        .padding(16)
        .margin({left: 16, right: 16})
        
        // æ§åˆ¶æŒ‰é’®åŒºåŸŸ
        Row({space: 15}) {
          // ç¯å…‰å¼€å…³æŒ‰é’®
          Column({space: 8}) {
            Button() {
              Text('ğŸ’¡')
                .fontSize(24)
                .fontColor('#ffffff')
            }
            .width(60)
            .height(60)
            .borderRadius(30)
            .backgroundColor(this.lightStatus ? '#0066cc' : '#ffffff')
            .border({
              width: 2,
              color: this.lightStatus ? '#0066cc' : '#cccccc'
            })
            .onClick(() => {
              this.lightStatus = !this.lightStatus;
              // å‘é€ç¯å…‰æ§åˆ¶æŒ‡ä»¤
              const onoffValue = this.lightStatus ? 'ON' : 'OFF';
              this.controlLight(onoffValue);
              console.log('ç¯å…‰å¼€å…³çŠ¶æ€:', this.lightStatus);
            })
            
            Text('ç¯å…‰å¼€å…³')
              .fontSize(14)
              .fontColor('#666666')
          }
          
          // éœ‡åŠ¨å¼€å…³æŒ‰é’®
          Column({space: 8}) {
            Button() {
              Text('ğŸ“³')
                .fontSize(24)
                .fontColor('#ffffff')
            }
            .width(60)
            .height(60)
            .borderRadius(30)
            .backgroundColor(this.vibrationStatus ? '#0066cc' : '#ffffff')
            .border({
              width: 2,
              color: this.vibrationStatus ? '#0066cc' : '#cccccc'
            })
            .onClick(() => {
              this.vibrationStatus = !this.vibrationStatus;
              // å‘é€éœ‡åŠ¨æ§åˆ¶æŒ‡ä»¤
              const onoffValue = this.vibrationStatus ? 'ON' : 'OFF';
              this.controlMotor(onoffValue);
              console.log('éœ‡åŠ¨å¼€å…³çŠ¶æ€:', this.vibrationStatus);
            })
            
            Text('éœ‡åŠ¨å¼€å…³')
              .fontSize(14)
              .fontColor('#666666')
          }
          
          // å¯»æ‰¾è¯ç®±æŒ‰é’®
          Column({space: 8}) {
            Button() {
              Text('ğŸ”')
                .fontSize(24)
                .fontColor(this.findBoxStatus ? '#ffffff' : '#666666')
            }
            .width(60)
            .height(60)
            .borderRadius(30)
            .backgroundColor(this.findBoxStatus ? '#0066cc' : '#ffffff')
            .border({
              width: 2,
              color: this.findBoxStatus ? '#0066cc' : '#cccccc'
            })
            .onClick(() => {
              this.findBoxStatus = !this.findBoxStatus;
              // åŒæ­¥æ›´æ–°éœ‡åŠ¨çŠ¶æ€
              this.vibrationStatus = this.findBoxStatus;
              // å‘é€å¯»æ‰¾è¯ç®±æŒ‡ä»¤
              this.findBox();
              console.log('å¯»æ‰¾è¯ç®±æŒ‡ä»¤å·²å‘é€, çŠ¶æ€:', this.findBoxStatus);
            })
            
            Text('å¯»æ‰¾è¯ç®±')
              .fontSize(14)
              .fontColor('#666666')
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceEvenly)
        .padding({left: 16, right: 16, top: 16, bottom: 16})
        
        // åº•éƒ¨ä¿¡æ¯å¡ç‰‡
        Column({space: 16}){
          // ç¬¬ä¸€è¡Œï¼šæ¹¿åº¦å’Œæ¸©åº¦
          Row({space: 16}){
            // æ¹¿åº¦å¡ç‰‡
            Column({space: 8}){
              Row({space: 8}){
                Text('ğŸ’§ï¸')
                  .fontSize(20)
                Text('å½“å‰æ¹¿åº¦')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                
                Blank()
              }
              .width('100%')
              
              Row(){
                Text(`${this.sensorInfo.humidity}%`)
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333333')
                Blank()
              }
              .width('100%')
            }
            .width(170)
            .height(120)
            .backgroundColor('#ffffff')
            .borderRadius(12)
            .padding(12)

            // æ¸©åº¦å¡ç‰‡
            Column({space: 8}){
              Row({space: 8}){
                Text('ğŸŒ¡ï¸ï¸')
                  .fontSize(20)
                Text('å½“å‰æ¸©åº¦')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)

                Blank()
              }
              .width('100%')

              Row(){
                Text(`${this.sensorInfo.temperature}Â°C`)
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333333')
                Blank()
              }
              .width('100%')
            }
            .width(170)
            .height(120)
            .backgroundColor('#ffffff')
            .borderRadius(12)
            .padding(12)
          }
          .width('100%')
          
          // ç¬¬äºŒè¡Œï¼šå…‰ç…§å¼ºåº¦å’Œå¯ç‡ƒæ°”ä½“å€¼
          Row({space: 16}){
            // å…‰ç…§å¼ºåº¦å¡ç‰‡
            Column({space: 8}){
              Row({space: 8}){
                Text('â˜€ï¸')
                  .fontSize(20)
                Text('å…‰ç…§å¼ºåº¦')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                
                Blank()
              }
              .width('100%')
              
              Row(){
                Text(`${this.sensorInfo.illumination}lux`)
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333333')
                Blank()
              }
              .width('100%')
            }
            .width(170)
            .height(120)
            .backgroundColor('#ffffff')
            .borderRadius(12)
            .padding(12)

            // å¯ç‡ƒæ°”ä½“å¡ç‰‡
            Column({space: 8}){
              Row({space: 8}){
                Text('ğŸ’¨')
                  .fontSize(20)
                Text('å¯ç‡ƒæ°”ä½“å€¼')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)

                Blank()
              }
              .width('100%')

              Row(){
                Text(`${this.sensorInfo.gas}ppm`)
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.sensorInfo.gas > 1000 ? '#ff0000' : '#333333')
                Blank()
              }
              .width('100%')
            }
            .width(170)
            .height(120)
            .backgroundColor('#ffffff')
            .borderRadius(12)
            .padding(12)
          }
          .width('100%')
          
          // ç¬¬ä¸‰è¡Œï¼šå¯èƒ½æ¼æœçš„è¯å“å¡ç‰‡
          Column({space: 12}) {
            Row({space: 8}) {
              Text('ğŸ’Š')
                .fontSize(20)
              Text('å¯èƒ½æ¼æœçš„è¯å“')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
              
              Blank()
            }
            .width('100%')
            
            // æ¼æœè¯å“åˆ—è¡¨
            Column({space: 8}) {
              ForEach(this.getMissedMedicines(), (item: MissedMedicineItem, index: number) => {
                Row({space: 12}) {
                  Column({space: 4}) {
                    Text(item.medicine.name)
                      .fontSize(14)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#333333')
                    Text(`åº”æœæ—¶é—´: ${item.missedTime}`)
                      .fontSize(12)
                      .fontColor('#666666')
                    Text(`ä½ç½®: ${item.medicine.location}`)
                      .fontSize(12)
                      .fontColor('#999999')
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)
                  
                  Button('å·²æœè¯')
                    .fontSize(12)
                    .fontColor('#ffffff')
                    .backgroundColor('#28a745')
                    .borderRadius(6)
                    .padding({left: 12, right: 12, top: 6, bottom: 6})
                    .onClick(() => {
                      this.markMedicineAsTaken(item.medicine.id, item.missedTime);
                    })
                }
                .width('100%')
                .padding({left: 12, right: 12, top: 8, bottom: 8})
                .backgroundColor('#f8f9fa')
                .borderRadius(8)
}, (item: MissedMedicineItem, index: number) => `${item.medicine.id}-${item.missedTime}-${index}`)              
              // å¦‚æœæ²¡æœ‰æ¼æœè¯å“ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
              if (this.getMissedMedicines().length === 0) {
                Row() {
                  Text('æš‚æ— æ¼æœè¯å“')
                    .fontSize(14)
                    .fontColor('#999999')
                    .textAlign(TextAlign.Center)
                }
                .width('100%')
                .justifyContent(FlexAlign.Center)
                .padding({top: 20, bottom: 20})
              }
            }
            .width('100%')
          }
          .width('100%')
          .backgroundColor('#ffffff')
          .borderRadius(12)
          .padding(16)
        }
        .width('100%')
        .padding({left: 16, right: 16, bottom: 20})

      }
      .width('100%')
      .backgroundColor('#f5f5f5')


      
    }
    .width('100%')
    .height('100%')
    .scrollable(ScrollDirection.Vertical)
    .scrollBar(BarState.Auto)
  }

  private getMissedMedicines(): Array<MissedMedicineItem> {
    const now = new Date();
    const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    const currentDate = now.toDateString();
    const missedMedicines: Array<MissedMedicineItem> = [];
    
    this.medicineList.forEach((medicine: Medicine) => {
      medicine.times.forEach((time: string) => {
        const checkKey = `${medicine.id}-${time}-${currentDate}`;
        
        // æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦å·²ç»è¶…è¿‡æœè¯æ—¶é—´ï¼Œä¸”ä»Šå¤©è¿˜æœªæœè¯
        if (currentTime > time && !this.checkedMedicines.has(checkKey)) {
          missedMedicines.push({
            medicine: medicine,
            missedTime: time
          });
        }
      });
    });
    
    return missedMedicines;
  }



  // æ ‡è®°è¯å“å·²æœç”¨çš„æ–¹æ³•
  private markMedicineAsTaken(medicineId: number, time: string): void {
    const now = new Date();
    const currentDate = now.toDateString();
    const checkKey = `${medicineId}-${time}-${currentDate}`;
    
    // æ·»åŠ åˆ°å·²æ£€æŸ¥è®°å½•ä¸­
    this.checkedMedicines.add(checkKey);
    
    // è§¦å‘UIæ›´æ–° - é€šè¿‡æ›´æ–°ä¸€ä¸ªçŠ¶æ€å˜é‡æ¥å¼ºåˆ¶åˆ·æ–°
    this.medicineList = [...this.medicineList];
    
    console.log(`è¯å“å·²æ ‡è®°ä¸ºå·²æœç”¨: ID=${medicineId}, æ—¶é—´=${time}`);
    hilog.info(2311, 'testTag', `è¯å“å·²æ ‡è®°ä¸ºå·²æœç”¨: ID=${medicineId}, æ—¶é—´=${time}`);
  }

  // å‘é€MQTTæ§åˆ¶å‘½ä»¤çš„æ–¹æ³•
  sendMqttControl = (location: string): void => {
    const token = IAMTokenPreferencesDataUtil.init().getPreferencesData('token');
    const url = 'https://61357a1900.st1.iotda-app.cn-north-4.myhuaweicloud.com:443/v5/iot/5390eb2140d2435c91cadccf942fb3eb/devices/685f8b5ed582f2001835e760_Smart_Medicien_Box/commands';
    
    const requestData: MqttControlRequest = {
      service_id: "IntelligentCookpit",
      command_name: "mqtt_control",
      paras: {
        value: location
      }
    };

    const axiosInstance = axios.create({
      headers: {
        "Content-Type": "application/json",
        "X-Auth-Token": token
      }
    });

    axiosInstance.post(url, requestData).then((response: AxiosResponse) => {
      console.log(`MQTTæ§åˆ¶æˆåŠŸï¼Œä½ç½®${location}:`, JSON.stringify(response.data));
      hilog.info(2311, 'testTag', `MQTTæ§åˆ¶æˆåŠŸï¼Œä½ç½®${location}:`, JSON.stringify(response.data));
      
      // å‘é€æˆåŠŸåå¼€å¯beep_control
      this.sendBeepControl('ON');
    }).catch((error: AxiosError) => {
      console.log(`MQTTæ§åˆ¶å¤±è´¥ï¼Œä½ç½®${location}:`, JSON.stringify(error));
      hilog.error(2311, 'testTag', `MQTTæ§åˆ¶å¤±è´¥ï¼Œä½ç½®${location}:`, JSON.stringify(error));
    });
  }

  // å‘é€èœ‚é¸£å™¨æ§åˆ¶å‘½ä»¤çš„æ–¹æ³•
  sendBeepControl = (onoff: string): void => {
    const token = IAMTokenPreferencesDataUtil.init().getPreferencesData('token');
    const url = 'https://61357a1900.st1.iotda-app.cn-north-4.myhuaweicloud.com:443/v5/iot/5390eb2140d2435c91cadccf942fb3eb/devices/685f8b5ed582f2001835e760_Smart_Medicien_Box/commands';
    
    const requestData: BeepControlRequest = {
      service_id: "IntelligentCookpit",
      command_name: "beep_control",
      paras: {
        onoff: onoff
      }
    };
    
    const axiosInstance = axios.create({
      headers: {
        "Content-Type": "application/json",
        "X-Auth-Token": token
      }
    });

    axiosInstance.post(url, requestData).then((response: AxiosResponse) => {
      console.log(`èœ‚é¸£å™¨æ§åˆ¶æˆåŠŸï¼ŒçŠ¶æ€${onoff}:`, JSON.stringify(response.data));
      hilog.info(2311, 'testTag', `èœ‚é¸£å™¨æ§åˆ¶æˆåŠŸï¼ŒçŠ¶æ€${onoff}:`, JSON.stringify(response.data));
    }).catch((error: AxiosError) => {
      console.log(`èœ‚é¸£å™¨æ§åˆ¶å¤±è´¥ï¼ŒçŠ¶æ€${onoff}:`, JSON.stringify(error));
      hilog.error(2311, 'testTag', `èœ‚é¸£å™¨æ§åˆ¶å¤±è´¥ï¼ŒçŠ¶æ€${onoff}:`, JSON.stringify(error));
    });
  }

  // è·å–è¯å“æ•°æ®çš„æ–¹æ³•
  private getMedicineData(): void {
    // ä»æœ¬åœ°å­˜å‚¨è·å–è¯å“æ•°æ®ï¼Œè¿™é‡Œæ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”è¯¥ä»DeviceSearchComponentè·å–
    const medicineData = IAMTokenPreferencesDataUtil.init().getPreferencesData('medicineList');
    if (medicineData) {
      try {
        this.medicineList = JSON.parse(medicineData);
      } catch (error) {
        console.log('è§£æè¯å“æ•°æ®å¤±è´¥:', error);
        // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
        this.medicineList = [
          {
            id: 1,
            name: 'é˜¿å¸åŒ¹æ—',
            times: ['08:00'],
            frequency: 'æ¯æ—¥ä¸€æ¬¡',
            location: 'A1'
          },
          {
            id: 2,
            name: 'ç»´ç”Ÿç´ C',
            times: ['08:00', '20:00'],
            frequency: 'æ¯æ—¥ä¸¤æ¬¡',
            location: 'B1'
          }
        ];
      }
    } else {
      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
      this.medicineList = [
        {
          id: 1,
          name: 'é˜¿å¸åŒ¹æ—',
          times: ['08:00'],
          frequency: 'æ¯æ—¥ä¸€æ¬¡',
          location: 'A1'
        },
        {
          id: 2,
          name: 'ç»´ç”Ÿç´ C',
          times: ['08:00', '20:00'],
          frequency: 'æ¯æ—¥ä¸¤æ¬¡',
          location: 'B1'
        }
      ];
    }
  }

  // æ£€æŸ¥æœè¯æ—¶é—´çš„æ–¹æ³•
  private checkMedicineTime(): void {
    const now = new Date();
    const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    const currentDate = now.toDateString(); // è·å–å½“å‰æ—¥æœŸï¼Œç”¨äºé¿å…åŒä¸€å¤©é‡å¤æé†’

    // æ”¶é›†å½“å‰æ—¶é—´éœ€è¦æœè¯çš„è¯å“ä½ç½®
    const medicineLocations: string[] = [];
    
    this.medicineList.forEach((medicine: Medicine) => {
      medicine.times.forEach((time: string) => {
        const checkKey = `${medicine.id}-${time}-${currentDate}`; // åˆ›å»ºå”¯ä¸€æ ‡è¯†
        
        // æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åŒ¹é…æœè¯æ—¶é—´ï¼Œä¸”ä»Šå¤©è¿˜æœªæé†’è¿‡
        if (currentTime === time && !this.checkedMedicines.has(checkKey)) {
          console.log(`æœè¯æ—¶é—´åˆ°äº†ï¼è¯å“ï¼š${medicine.name}ï¼Œæ—¶é—´ï¼š${time}ï¼Œä½ç½®ï¼š${medicine.location}`);
          hilog.info(2311, 'testTag', `æœè¯æ—¶é—´åˆ°äº†ï¼è¯å“ï¼š${medicine.name}ï¼Œæ—¶é—´ï¼š${time}ï¼Œä½ç½®ï¼š${medicine.location}`);
          
          // æ”¶é›†éœ€è¦å‘é€çš„ä½ç½®ä¿¡æ¯
          medicineLocations.push(medicine.location);
          
          // æ ‡è®°ä¸ºå·²æ£€æŸ¥ï¼Œé¿å…é‡å¤æé†’
          this.checkedMedicines.add(checkKey);
        }
      });
    });

    // å¦‚æœæœ‰éœ€è¦æœè¯çš„è¯å“ï¼ŒæŒ‰é¡ºåºå‘é€ä½ç½®ä¿¡æ¯
    if (medicineLocations.length > 0) {
      this.sendMedicineLocationsSequentially(medicineLocations);
    }

    // æ¸…ç†è¿‡æœŸçš„æ£€æŸ¥è®°å½•ï¼ˆä¿ç•™æœ€è¿‘3å¤©çš„è®°å½•ï¼‰
    const threeDaysAgo = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000).toDateString();
    const keysToDelete: string[] = [];
    this.checkedMedicines.forEach((key: string) => {
      const keyDate = key.split('-')[2];
      if (keyDate < threeDaysAgo) {
        keysToDelete.push(key);
      }
    });
    keysToDelete.forEach(key => this.checkedMedicines.delete(key));
  }

  // æŒ‰é¡ºåºå‘é€è¯å“ä½ç½®ä¿¡æ¯çš„æ–¹æ³•
  private sendMedicineLocationsSequentially(locations: string[]): void {
    locations.forEach((location: string, index: number) => {
      setTimeout(() => {
        this.sendMqttControl(location);
        console.log(`å‘é€ç¬¬${index + 1}ä¸ªä½ç½®ä¿¡æ¯ï¼š${location}`);
        hilog.info(2311, 'testTag', `å‘é€ç¬¬${index + 1}ä¸ªä½ç½®ä¿¡æ¯ï¼š${location}`);
      }, index * 60000); // æ¯ä¸ªä½ç½®é—´éš”60000æ¯«ç§’
    });
  }

  aboutToAppear(){
    // åˆå§‹åŒ–å½“å‰ç”¨æˆ·å
    this.currentUserName = this.getUserNameFromStorage();
    
    // è·å–è¯å“æ•°æ®
    this.getMedicineData();
    
    // å½“é¡µé¢å‡ºç°æ—¶è·å–è®¾å¤‡æ•°æ®
    this.getSensorAll();

    // æ¯éš”3ç§’åŠ è½½ä¸€æ¬¡æ•°æ®ï¼ŒåŒæ—¶æ£€æŸ¥ç”¨æˆ·åˆ‡æ¢å’Œæœè¯æ—¶é—´
    this.timerId = setInterval(()=>{
      this.getSensorAll();
      this.checkUserChange(); // æ·»åŠ ç”¨æˆ·åˆ‡æ¢æ£€æŸ¥
      this.checkMedicineTime(); // æ·»åŠ æœè¯æ—¶é—´æ£€æŸ¥
    }, 3000)
  }

  aboutToDisappear() {
    // é¡µé¢é”€æ¯æ—¶æ¸…é™¤å®šæ—¶å™¨
    if (this.timerId) {
      clearInterval(this.timerId);
    }
    // æ¸…é™¤å¯»æ‰¾è¯ç®±å®šæ—¶å™¨
    if (this.findBoxTimerId) {
      clearTimeout(this.findBoxTimerId);
    }
  }
}
